<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tooth Tales - Complete Patient Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        /* All your existing CSS styles remain exactly the same */
        :root {
            --primary: #2a87a5;
            --primary-light: #e1f0f5;
            --primary-dark: #1d6a83;
            --secondary: #f8f9fa;
            --accent: #e3f2fd;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196F3;
            --text: #333;
            --light-text: #6c757d;
            --border: #dee2e6;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --radius: 12px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--text);
            background-color: #f5f9fc;
            padding: 0;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Header Styles */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            background: linear-gradient(135deg, #f5f9fc 0%, white 100%);
            border: 1px solid rgba(42, 135, 165, 0.1);
            transform: translateY(0);
            transition: var(--transition);
        }
        
        .header:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .logo {
            height: 120px;
            margin-right: 20px;
            transition: var(--transition);
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        .clinic-info {
            text-align: left;
        }
        
        .title {
            color: var(--primary);
            font-weight: 700;
            font-size: 2.2rem;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #2a87a5, #4bb5d6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: var(--light-text);
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .tagline {
            font-style: italic;
            color: var(--primary);
            font-weight: 500;
            position: relative;
            display: inline-block;
        }
        
        .tagline:after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            bottom: -5px;
            left: 0;
            background: linear-gradient(to right, var(--primary), transparent);
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.5s ease;
        }
        
        .tagline:hover:after {
            transform: scaleX(1);
            transform-origin: left;
        }
        
        .datetime {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 0.9rem;
            color: white;
            background: var(--primary);
            padding: 8px 15px;
            border-radius: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(42, 135, 165, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(42, 135, 165, 0); }
            100% { box-shadow: 0 0 0 0 rgba(42, 135, 165, 0); }
        }
        
        /* Form Card Styles */
        .form-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(42, 135, 165, 0.1);
            transform: translateY(0);
            transition: var(--transition);
        }
        
        .form-card:hover {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .section-title {
            color: var(--primary);
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light);
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .section-title:after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 50px;
            height: 2px;
            background: var(--primary);
        }
        
        .section-title i {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text);
        }
        
        .form-label.required:after {
            content: " *";
            color: var(--danger);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: var(--transition);
            background-color: #fcfcfc;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(42, 135, 165, 0.1);
            background-color: white;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .checkbox-group, .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .checkbox-item, .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
            padding: 5px 10px;
            border-radius: 6px;
        }
        
        .checkbox-item:hover, .radio-item:hover {
            background: var(--primary-light);
        }
        
        .checkbox-item input, .radio-item input {
            margin: 0;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Special Sections */
        .medical-history {
            background-color: #f0f7fa;
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            border-left: 4px solid var(--primary);
            transform: translateY(0);
            transition: var(--transition);
        }
        
        .medical-history:hover {
            transform: translateY(-3px);
        }
        
        .habits-section {
            background-color: #f0f7fa;
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            border-left: 4px solid #2a87a5;
            transform: translateY(0);
            transition: var(--transition);
        }
        
        .habits-section:hover {
            transform: translateY(-3px);
        }
        
        .consent-section {
            background-color: #f8f5ff;
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            border-left: 4px solid #6a5acd;
            transform: translateY(0);
            transition: var(--transition);
        }
        
        .consent-section:hover {
            transform: translateY(-3px);
        }
        
        .clinical-section {
            background-color: #fff8e1;
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            border-left: 4px solid #ffc107;
            transform: translateY(0);
            transition: var(--transition);
        }
        
        .clinical-section:hover {
            transform: translateY(-3px);
        }
        
        .payment-section {
            background-color: #e8f5e9;
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            border-left: 4px solid #4caf50;
            transform: translateY(0);
            transition: var(--transition);
        }
        
        .payment-section:hover {
            transform: translateY(-3px);
        }
        
        /* Signature Section */
        .signature-container {
            margin-top: 20px;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        #signature-pad {
            border: 1px solid var(--border);
            background: white;
            width: 100%;
            height: 150px;
            cursor: crosshair;
            display: block;
            touch-action: none;
        }
        
        .signature-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border-radius: 30px;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .btn i {
            font-size: 1em;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(42, 135, 165, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background-color: #e9ecef;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.1);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
        }
        
        .btn-info {
            background-color: var(--info);
            color: white;
        }
        
        .btn-info:hover {
            background-color: #0b7dda;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }
        
        /* Form Actions */
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-registered {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .status-in-consultation {
            background-color: #fff8e1;
            color: #ff8f00;
        }
        
        .status-completed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        /* Treatment Table */
        .treatment-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .treatment-table th, .treatment-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        .treatment-table th {
            background-color: #f2f2f2;
        }
        
        .treatment-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .treatment-table tr:hover {
            background-color: #f1f1f1;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 20px 15px;
            }
            
            .logo-container {
                flex-direction: column;
                text-align: center;
            }
            
            .logo {
                margin-right: 0;
                margin-bottom: 15px;
                height: 100px;
            }
            
            .datetime {
                position: static;
                margin-top: 15px;
                display: inline-block;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        /* Animation for form sections */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .form-section {
            animation: fadeIn 0.5s ease-out forwards;
            margin-bottom: 40px;
            opacity: 0;
        }
        
        .form-section:nth-child(1) { animation-delay: 0.1s; }
        .form-section:nth-child(2) { animation-delay: 0.2s; }
        .form-section:nth-child(3) { animation-delay: 0.3s; }
        .form-section:nth-child(4) { animation-delay: 0.4s; }
        .form-section:nth-child(5) { animation-delay: 0.5s; }
        .form-section:nth-child(6) { animation-delay: 0.6s; }
        .form-section:nth-child(7) { animation-delay: 0.7s; }
        
        /* Custom form elements */
        .inline-fields {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .inline-fields .form-control {
            flex: 1;
        }
        
        .consent-text {
            line-height: 2;
            margin-bottom: 20px;
            font-size: 1rem;
        }
        
        .consent-text input {
            border-bottom: 1px solid var(--text);
            border-top: none;
            border-left: none;
            border-right: none;
            background: transparent;
            padding: 0 5px;
            text-align: center;
            min-width: 200px;
            font-family: inherit;
            transition: var(--transition);
        }
        
        .consent-text input:focus {
            border-bottom: 2px solid var(--primary);
            outline: none;
        }
        
        /* Loading spinner */
        .spinner {
            display: none;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none;
            }
            
            body {
                background: white;
                padding: 0;
                font-size: 12pt;
            }
            
            .form-card {
                box-shadow: none;
                padding: 0;
                border: none;
            }
            
            .btn {
                display: none;
            }
            
            .header {
                box-shadow: none;
                border: none;
                background: white !important;
                padding: 0 0 20px 0;
            }
        }
        
        /* Select2 customizations */
        .select2-container--default .select2-selection--single {
            height: 45px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 45px;
            padding-left: 15px;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 43px;
        }
        
        /* Tab navigation */
        .form-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .form-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }
        
        .form-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .form-tab:hover:not(.active) {
            background-color: var(--primary-light);
        }
        
        .form-tab-content {
            display: none;
        }
        
        .form-tab-content.active {
            display: block;
        }

        /* Search button styles */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-container input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="tooth-tales-logo.png" alt="Tooth Tales Logo" class="logo">
                <div class="clinic-info">
                    <h1 class="title">Tooth Tales Dental Clinic</h1>
                    <p class="subtitle">Comprehensive Dental Care for the Whole Family</p>
                    <p class="tagline">Reason to Smile</p>
                </div>
            </div>
            <div class="datetime" id="datetime"></div>
        </div>
        
        <form id="patientForm" class="form-card">
            <!-- Search Button Section -->
            <div class="search-container">
                <input type="text" class="form-control" id="searchInput" placeholder="Search patient by name or mobile number">
                <button type="button" class="btn btn-primary" id="searchBtn">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="form-tabs">
                <div class="form-tab active" data-tab="registration">Registration</div>
                <div class="form-tab" data-tab="clinical">Clinical</div>
                <div class="form-tab" data-tab="payment">Payment</div>
            </div>
            
            <!-- Registration Tab -->
            <div class="form-tab-content active" id="registration-tab">
                <!-- Clinic Details Section -->
                <div class="form-section">
                    <h2 class="section-title"><i class="fas fa-clinic-medical"></i> Clinic Details</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Dr. Incharge</label>
                            <input type="text" class="form-control" name="dr_incharge" value="Dr. Shiwangi Rangra (B.D.S)" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Staff Incharge</label>
                            <input type="text" class="form-control" name="staff_incharge" required placeholder="Staff member name">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Date</label>
                            <input type="date" class="form-control" name="date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Consultation Fee (₹)</label>
                            <input type="number" class="form-control" name="consultation_fee" placeholder="500">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" required>
                                <option value="registered">Registered</option>
                                <option value="in_consultation">In Consultation</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Information Section -->
                <div class="form-section">
                    <h2 class="section-title"><i class="fas fa-user-injured"></i> Patient Information</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required">Patient Name</label>
                            <input type="text" class="form-control" name="patient_name" required placeholder="Full name" id="patientNameInput">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Father/Husband Name</label>
                            <input type="text" class="form-control" name="guardian_name" placeholder="Guardian's name" id="guardianNameInput">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth / Age</label>
                            <div class="inline-fields">
                                <input type="date" class="form-control" name="dob">
                                <input type="number" class="form-control" name="age" placeholder="Age">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Gender</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="gender" value="male" required> Male
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="gender" value="female"> Female
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="gender" value="other"> Other
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Mobile Number</label>
                            <input type="tel" class="form-control" name="mobile" required placeholder="9876543210" pattern="[0-9]{10}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Marital Status</label>
                            <select class="form-control" name="marital_status">
                                <option value="">Select</option>
                                <option value="single">Single</option>
                                <option value="married">Married</option>
                                <option value="divorced">Divorced</option>
                                <option value="widowed">Widowed</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" name="address" placeholder="Full address"></textarea>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Area</label>
                            <input type="text" class="form-control" name="area" placeholder="Locality/Area">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" name="city" placeholder="City">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Occupation</label>
                            <input type="text" class="form-control" name="Occupation" placeholder="Occupation">
                        </div>
                    </div>
                </div>
                
                <!-- Referral Source Section -->
                <div class="form-section">
                    <h2 class="section-title"><i class="fas fa-question-circle"></i> How Did You Know About Us?</h2>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="referral_source" value="facebook"> <i class="fab fa-facebook"></i> Facebook
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="referral_source" value="google"> <i class="fab fa-google"></i> Google
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="referral_source" value="youtube"> <i class="fab fa-youtube"></i> YouTube
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="referral_source" value="newspaper"> <i class="fas fa-newspaper"></i> Newspaper/Radio
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="referral_source" value="referral"> <i class="fas fa-user-friends"></i> Referral (Friend/Family)
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="referral_source" value="other"> Other
                            <input type="text" name="referral_other" placeholder="Please specify" style="width: 120px; margin-left: 5px;">
                        </label>
                    </div>
                </div>
                
                <!-- Medical History Section -->
                <div class="form-section medical-history">
                    <h2 class="section-title"><i class="fas fa-heartbeat"></i> Medical History</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="diabetes"> <i class="fas fa-syringe"></i> Diabetes
                            </label>
                            <input type="text" class="form-control" name="diabetes_status" placeholder="Status/Details" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="hypertension"> <i class="fas fa-heart"></i> Hypertension (B.P)
                            </label>
                            <input type="text" class="form-control" name="hypertension_status" placeholder="Status/Details" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="thyroid"> <i class="fas fa-bolt"></i> Thyroid
                            </label>
                            <input type="text" class="form-control" name="thyroid_status" placeholder="Status/Details" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="hepatitis"> <i class="fas fa-liver"></i> Hepatitis
                            </label>
                            <input type="text" class="form-control" name="hepatitis_status" placeholder="Status/Details" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="aids"> <i class="fas fa-virus"></i> AIDS/HIV
                            </label>
                            <input type="text" class="form-control" name="aids_status" placeholder="Status/Details" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="cardiac"> <i class="fas fa-heartbeat"></i> Cardiac History
                            </label>
                            <input type="text" class="form-control" name="cardiac_status" placeholder="Status/Details" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="renal"> <i class="fas fa-kidneys"></i> Renal History
                            </label>
                            <input type="text" class="form-control" name="renal_status" placeholder="Status/Details" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="persistent_cough"> <i class="fas fa-lungs"></i> Persistent Cough (>1 month)
                            </label>
                            <input type="text" class="form-control" name="cough_status" placeholder="Status/Details" style="margin-top: 8px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Other Conditions</label>
                        <input type="text" class="form-control" name="other_conditions" placeholder="Any other medical conditions">
                    </div>
                </div>
                
                <!-- Habits Section -->
                <div class="form-section habits-section">
                    <h2 class="section-title"><i class="fas fa-smoking"></i> Habits & Additional Information</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="allergy"> <i class="fas fa-allergies"></i> Allergy
                            </label>
                            <input type="text" class="form-control" name="allergy_details" placeholder="Specify allergy details" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="pregnant"> <i class="fas fa-baby"></i> Pregnant/Lactating
                            </label>
                            <input type="text" class="form-control" name="pregnant_details" placeholder="Specify details" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="smoking"> <i class="fas fa-smoking"></i> Smoking
                            </label>
                            <input type="text" class="form-control" name="smoking_details" placeholder="Frequency/duration" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="alcohol"> <i class="fas fa-wine-glass-alt"></i> Alcohol
                            </label>
                            <input type="text" class="form-control" name="alcohol_details" placeholder="Frequency/type" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="tobacco"> <i class="fas fa-chewing-tobacco"></i> Tobacco Chewing
                            </label>
                            <input type="text" class="form-control" name="tobacco_details" placeholder="Frequency/type" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="thumb_sucking"> <i class="fas fa-hand-holding"></i> Thumb Sucking
                            </label>
                            <input type="text" class="form-control" name="thumb_sucking_details" placeholder="Age/frequency" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="spo2"> <i class="fas fa-lungs"></i> SPO2 Level
                            </label>
                            <input type="text" class="form-control" name="spo2_level" placeholder="% level" style="margin-top: 8px;">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="brushing"> <i class="fas fa-toothbrush"></i> Brushing Frequency
                            </label>
                            <input type="text" class="form-control" name="brushing_details" placeholder="Times per day" style="margin-top: 8px;">
                        </div>
                    </div>
                </div>
                
                <!-- Consent Section -->
                <div class="form-section consent-section">
                    <h2 class="section-title"><i class="fas fa-file-signature"></i> Consent For Treatment</h2>
                    <div class="form-group">
                        <p class="consent-text">
                            "I, <input type="text" name="consent_patient_name" placeholder="Patient Name" id="consentPatientName">,
                            W/O / S/O / D/O
                            <input type="text" name="consent_guardian_name" placeholder="Guardian Name" id="consentGuardianName">,
                            voluntarily consent to dental examination, treatment, and procedures (including X-rays) as deemed necessary by the dentist at Tooth Tales Dental Clinic."
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Patient's Signature</label>
                        <div class="signature-container">
                            <canvas id="signature-pad"></canvas>
                            <div class="signature-actions">
                                <button type="button" class="btn btn-danger" id="clear-signature">
                                    <i class="fas fa-eraser"></i> Clear Signature
                                </button>
                            </div>
                            <input type="hidden" id="signature-data" name="signature_data">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" name="consent_date">
                    </div>
                </div>
            </div>
            
            <!-- Clinical Tab -->
            <div class="form-tab-content" id="clinical-tab">
                <!-- Dental Assessment Section -->
                <div class="form-section clinical-section">
                    <h2 class="section-title"><i class="fas fa-tooth"></i> Dental Assessment</h2>
                    <div class="form-group">
                        <label class="form-label">Chief Complaint</label>
                        <textarea class="form-control" name="chief_complaint" placeholder="Patient's main dental concern"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Past Dental History</label>
                        <textarea class="form-control" name="past_dental_history" placeholder="Previous dental treatments or issues"></textarea>
                    </div>
                    
                    <!-- Diagnosis Section -->
                    <div class="form-group">
                        <label class="form-label">Diagnosis</label>
                        <textarea class="form-control" name="diagnosis" placeholder="Clinical diagnosis"></textarea>
                    </div>
                    
                    <!-- Treatment Plan Section -->
                    <div class="form-group">
                        <label class="form-label">Treatment Plan</label>
                        <table class="treatment-table" id="treatmentTable">
                            <thead>
                                <tr>
                                    <th>Tooth</th>
                                    <th>Procedure</th>
                                    <th>Description</th>
                                    <th>Fee (₹)</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Treatments will be added here -->
                            </tbody>
                        </table>
                        <div class="form-grid" style="margin-top: 15px;">
                            <div class="form-group">
                                <input type="text" class="form-control" id="treatmentTooth" placeholder="Tooth Number">
                            </div>
                            <div class="form-group">
                                <select class="form-control" id="treatmentProcedure">
                                    <option value="">Select Procedure</option>
                                    <option value="Extraction">Extraction</option>
                                    <option value="Filling">Filling</option>
                                    <option value="Root Canal">Root Canal</option>
                                    <option value="Crown">Crown</option>
                                    <option value="Bridge">Bridge</option>
                                    <option value="Denture">Denture</option>
                                    <option value="Scaling">Scaling</option>
                                    <option value="Polishing">Polishing</option>
                                    <option value="Whitening">Whitening</option>
                                    <option value="Implant">Implant</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" id="treatmentDescription" placeholder="Description">
                            </div>
                            <div class="form-group">
                                <input type="number" class="form-control" id="treatmentFee" placeholder="Fee">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-primary" id="addTreatment">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Work Done Section -->
                    <div class="form-group">
                        <label class="form-label">Work Done Today</label>
                        <textarea class="form-control" name="work_done" placeholder="Procedures performed today"></textarea>
                    </div>
                    
                    <!-- Prescription Section -->
                    <div class="form-group">
                        <label class="form-label">Prescription</label>
                        <textarea class="form-control" name="prescription" placeholder="Medications prescribed"></textarea>
                    </div>
                    
                    <!-- Next Appointment Section -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Next Appointment Date</label>
                            <input type="datetime-local" class="form-control" name="next_appointment">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Purpose</label>
                            <input type="text" class="form-control" name="next_appointment_purpose" placeholder="Purpose of next visit">
                        </div>
                    </div>
                    
                    <!-- Remarks Section -->
                    <div class="form-group">
                        <label class="form-label">Doctor's Remarks</label>
                        <textarea class="form-control" name="remarks" placeholder="Additional notes"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Payment Tab -->
            <div class="form-tab-content" id="payment-tab">
                <div class="form-section payment-section">
                    <h2 class="section-title"><i class="fas fa-rupee-sign"></i> Payment Details</h2>
                    
                    <!-- Treatment Summary -->
                    <div class="form-group">
                        <label class="form-label">Treatment Summary</label>
                        <table class="treatment-table">
                            <thead>
                                <tr>
                                    <th>Procedure</th>
                                    <th>Tooth</th>
                                    <th>Fee (₹)</th>
                                </tr>
                            </thead>
                            <tbody id="paymentSummary">
                                <!-- Will be populated from treatment plan -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2">Total Fee</th>
                                    <th id="totalFee">₹0</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- Payment Details -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Amount Paid (₹)</label>
                            <input type="number" class="form-control" name="amount_paid" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Mode</label>
                            <select class="form-control" name="payment_mode">
                                <option value="cash">Cash</option>
                                <option value="credit_card">Credit Card</option>
                                <option value="debit_card">Debit Card</option>
                                <option value="upi">UPI</option>
                                <option value="net_banking">Net Banking</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Reference</label>
                            <input type="text" class="form-control" name="payment_reference" placeholder="Transaction/Cheque No.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Date</label>
                            <input type="datetime-local" class="form-control" name="payment_date">
                        </div>
                    </div>
                    
                    <!-- Balance Calculation -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Balance Amount (₹)</label>
                            <input type="number" class="form-control" name="balance_amount" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Status</label>
                            <select class="form-control" name="payment_status">
                                <option value="pending">Pending</option>
                                <option value="partial">Partial</option>
                                <option value="paid">Paid</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Payment Notes -->
                    <div class="form-group">
                        <label class="form-label">Payment Notes</label>
                        <textarea class="form-control" name="payment_notes" placeholder="Any additional payment details"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="form-actions">
                <button type="reset" class="btn btn-secondary">
                    <i class="fas fa-redo"></i> Reset Form
                </button>
                <button type="button" class="btn btn-primary" id="saveDraft">
                    <i class="fas fa-save"></i> Save Draft
                </button>
                <button type="submit" class="btn btn-success" id="submitBtn">
                    <i class="fas fa-check-circle"></i> Submit
                    <div class="spinner" id="submitSpinner"></div>
                </button>
                <button type="button" class="btn btn-success" id="saveAndPrintBtn">
                    <i class="fas fa-print"></i> Save and Print
                </button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Display current date and time with live updating
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('en-IN', options);
        }
        
        // Initialize and update every second
        updateDateTime();
        setInterval(updateDateTime, 1000);
        
        // Initialize tab navigation
        function initializeTabs() {
            const tabs = document.querySelectorAll('.form-tab');
            const tabContents = document.querySelectorAll('.form-tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }

        // Set current date as default if empty
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tabs first
            initializeTabs();
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="date"]').value = today;
            document.querySelector('input[name="consent_date"]').value = today;
            
            // Set current datetime for payment
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.querySelector('input[name="payment_date"]').value = localDateTime;
            
            // Auto-calculate age from DOB
            document.querySelector('input[name="dob"]').addEventListener('change', function() {
                if (this.value) {
                    const dob = new Date(this.value);
                    const ageDiff = Date.now() - dob.getTime();
                    const ageDate = new Date(ageDiff);
                    const calculatedAge = Math.abs(ageDate.getUTCFullYear() - 1970);
                    document.querySelector('input[name="age"]').value = calculatedAge;
                }
            });
            
            // Autofill consent form when patient details change
            document.getElementById('patientNameInput').addEventListener('input', function() {
                document.getElementById('consentPatientName').value = this.value;
            });
            
            document.getElementById('guardianNameInput').addEventListener('input', function() {
                document.getElementById('consentGuardianName').value = this.value;
            });
            
            // Initialize treatment procedures dropdown
            initializeTreatmentProcedures();
            
            // Initialize payment calculations
            initializePaymentCalculations();
            
            // Initialize search functionality
            initializeSearch();
        });

        // Treatment Procedures
        function initializeTreatmentProcedures() {
            const addBtn = document.getElementById('addTreatment');
            const tableBody = document.querySelector('#treatmentTable tbody');
            const paymentSummary = document.getElementById('paymentSummary');
            
            addBtn.addEventListener('click', function() {
                const tooth = document.getElementById('treatmentTooth').value;
                const procedure = document.getElementById('treatmentProcedure').value;
                const description = document.getElementById('treatmentDescription').value;
                const fee = document.getElementById('treatmentFee').value;
                
                if (!tooth || !procedure || !fee) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Incomplete Information',
                        text: 'Please enter tooth number, select procedure and enter fee',
                        confirmButtonColor: 'var(--primary)'
                    });
                    return;
                }
                
                // Add to treatment table
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${tooth}</td>
                    <td>${procedure}</td>
                    <td>${description || '-'}</td>
                    <td>₹${fee}</td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-treatment"><i class="fas fa-trash"></i></button></td>
                `;
                tableBody.appendChild(row);
                
                // Add to payment summary
                const paymentRow = document.createElement('tr');
                paymentRow.innerHTML = `
                    <td>${procedure}</td>
                    <td>${tooth}</td>
                    <td>₹${fee}</td>
                `;
                paymentSummary.appendChild(paymentRow);
                
                // Update total fee
                updateTotalFee();
                
                // Clear inputs
                document.getElementById('treatmentTooth').value = '';
                document.getElementById('treatmentDescription').value = '';
                document.getElementById('treatmentFee').value = '';
                
                // Add event listener to remove button
                row.querySelector('.remove-treatment').addEventListener('click', function() {
                    row.remove();
                    paymentRow.remove();
                    updateTotalFee();
                });
            });
            
            function updateTotalFee() {
                const fees = Array.from(document.querySelectorAll('#paymentSummary tr'))
                    .map(row => parseFloat(row.cells[2].textContent.replace('₹', ''))) || [0];
                const total = fees.reduce((sum, fee) => sum + fee, 0);
                document.getElementById('totalFee').textContent = `₹${total.toFixed(2)}`;
                document.querySelector('input[name="balance_amount"]').value = total - (parseFloat(document.querySelector('input[name="amount_paid"]').value) || 0);
            }
        }
        
        // Payment Calculations
        function initializePaymentCalculations() {
            const amountPaidInput = document.querySelector('input[name="amount_paid"]');
            const balanceAmountInput = document.querySelector('input[name="balance_amount"]');
            const paymentStatusSelect = document.querySelector('select[name="payment_status"]');
            
            amountPaidInput.addEventListener('input', function() {
                const totalFee = parseFloat(document.getElementById('totalFee').textContent.replace('₹', '')) || 0;
                const amountPaid = parseFloat(this.value) || 0;
                const balance = totalFee - amountPaid;
                
                balanceAmountInput.value = balance.toFixed(2);
                
                // Update payment status
                if (amountPaid <= 0) {
                    paymentStatusSelect.value = 'pending';
                } else if (balance > 0) {
                    paymentStatusSelect.value = 'partial';
                } else {
                    paymentStatusSelect.value = 'paid';
                }
            });
        }
        
        // Enhanced Signature Pad Functionality
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });
        
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            signaturePad.clear(); // otherwise isEmpty() might return incorrect value
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        document.getElementById('clear-signature').addEventListener('click', function() {
            signaturePad.clear();
            document.getElementById('signature-data').value = '';
        });
        
        function isCanvasBlank() {
            return signaturePad.isEmpty();
        }
        
        function resetCanvas() {
            signaturePad.clear();
            document.getElementById('signature-data').value = '';
        }
        
        // Handle Save and Print button click
        document.getElementById('saveAndPrintBtn').addEventListener('click', handleSaveAndPrint);
        
        async function handleSaveAndPrint() {
            const submitBtn = document.getElementById('saveAndPrintBtn');
            const originalText = submitBtn.innerHTML;
            
            try {
                // Show loading Occupation
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                // First save the form data
                await submitFormData();
                
                // Then print the form
                setTimeout(() => {
                    window.print();
                }, 500);
                
            } catch (error) {
                console.error('Error in save and print:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to save and print',
                    confirmButtonColor: 'var(--primary)'
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Form submission with validation
        document.getElementById('patientForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const spinner = document.getElementById('submitSpinner');
            
            try {
                // Show loading Occupation
                submitBtn.disabled = true;
                spinner.style.display = 'inline-block';

                // Validate required fields
                let isValid = true;
                document.querySelectorAll('[required]').forEach(field => {
                    if (!field.value.trim()) {
                        field.style.borderColor = 'var(--danger)';
                        isValid = false;
                    }
                });

                // Validate signature
                if (isCanvasBlank()) {
                    isValid = false;
                    await Swal.fire({
                        icon: 'error',
                        title: 'Signature Required',
                        text: 'Please sign the consent form',
                        confirmButtonColor: 'var(--primary)'
                    });
                }

                if (!isValid) {
                    throw new Error('Please complete all required fields');
                }

                // Submit the form data
                await submitFormData();
                
                // Reset form
                this.reset();
                resetCanvas();
                document.querySelector('#treatmentTable tbody').innerHTML = '';
                document.getElementById('paymentSummary').innerHTML = '';
                document.getElementById('totalFee').textContent = '₹0';
                
                // Show success message
                await Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Patient record saved successfully',
                    confirmButtonColor: 'var(--primary)'
                });
                
            } catch (error) {
                await Swal.fire({
                    icon: 'error',
                    title: 'Submission Failed',
                    text: error.message,
                    confirmButtonColor: 'var(--primary)'
                });
            } finally {
                submitBtn.disabled = false;
                spinner.style.display = 'none';
            }
        });
        
        // Function to submit form data
        async function submitFormData() {
            // Save signature if exists
            if (!signaturePad.isEmpty()) {
                document.getElementById('signature-data').value = signaturePad.toDataURL();
            }
            
            // Prepare treatment plan
            const treatments = [];
            document.querySelectorAll('#treatmentTable tbody tr').forEach(row => {
                treatments.push({
                    tooth: row.cells[0].textContent,
                    procedure: row.cells[1].textContent,
                    description: row.cells[2].textContent,
                    fee: row.cells[3].textContent.replace('₹', '')
                });
            });
            
            // Prepare form data
            const formData = {
                "ID": "", // Leave empty for auto-increment
                "Timestamp": new Date().toISOString(),
                "Status": document.querySelector('[name="status"]').value,
                "DrIncharge": document.querySelector('[name="dr_incharge"]').value,
                "StaffIncharge": document.querySelector('[name="staff_incharge"]').value,
                "Date": document.querySelector('[name="date"]').value,
                "ConsultationFee": document.querySelector('[name="consultation_fee"]').value || 0,
                "PatientName": document.querySelector('[name="patient_name"]').value,
                "GuardianName": document.querySelector('[name="guardian_name"]').value,
                "DateOfBirth": document.querySelector('[name="dob"]').value,
                "Age": document.querySelector('[name="age"]').value,
                "Gender": document.querySelector('[name="gender"]:checked')?.value,
                "Mobile": document.querySelector('[name="mobile"]').value,
                "MaritalStatus": document.querySelector('[name="marital_status"]').value,
                "Address": document.querySelector('[name="address"]').value,
                "Area": document.querySelector('[name="area"]').value,
                "City": document.querySelector('[name="city"]').value,
                "Occupation": document.querySelector('[name="Occupation"]').value,
                "ReferralSource": Array.from(document.querySelectorAll('[name="referral_source"]:checked')).map(el => el.value).join(', '),
                "ReferralOther": document.querySelector('[name="referral_other"]').value,
                "Diabetes": document.querySelector('[name="diabetes"]').checked ? 'Yes' : 'No',
                "DiabetesStatus": document.querySelector('[name="diabetes_status"]').value,
                "Hypertension": document.querySelector('[name="hypertension"]').checked ? 'Yes' : 'No',
                "HypertensionStatus": document.querySelector('[name="hypertension_status"]').value,
                "Thyroid": document.querySelector('[name="thyroid"]').checked ? 'Yes' : 'No',
                "ThyroidStatus": document.querySelector('[name="thyroid_status"]').value,
                "Hepatitis": document.querySelector('[name="hepatitis"]').checked ? 'Yes' : 'No',
                "HepatitisStatus": document.querySelector('[name="hepatitis_status"]').value,
                "AIDS": document.querySelector('[name="aids"]').checked ? 'Yes' : 'No',
                "AIDSStatus": document.querySelector('[name="aids_status"]').value,
                "Cardiac": document.querySelector('[name="cardiac"]').checked ? 'Yes' : 'No',
                "CardiacStatus": document.querySelector('[name="cardiac_status"]').value,
                "Renal": document.querySelector('[name="renal"]').checked ? 'Yes' : 'No',
                "RenalStatus": document.querySelector('[name="renal_status"]').value,
                "PersistentCough": document.querySelector('[name="persistent_cough"]').checked ? 'Yes' : 'No',
                "CoughStatus": document.querySelector('[name="cough_status"]').value,
                "OtherConditions": document.querySelector('[name="other_conditions"]').value,
                "Allergy": document.querySelector('[name="allergy_details"]').value || 'No',
                "Pregnant": document.querySelector('[name="pregnant_details"]').value || 'No',
                "Smoking": document.querySelector('[name="smoking_details"]').value || 'No',
                "Alcohol": document.querySelector('[name="alcohol_details"]').value || 'No',
                "Tobacco": document.querySelector('[name="tobacco_details"]').value || 'No',
                "ThumbSucking": document.querySelector('[name="thumb_sucking_details"]').value || 'No',
                "SPO2": document.querySelector('[name="spo2_level"]').value || 'Not specified',
                "BrushingFrequency": document.querySelector('[name="brushing_details"]').value || 'Not specified',
                "ChiefComplaint": document.querySelector('[name="chief_complaint"]').value,
                "PastDentalHistory": document.querySelector('[name="past_dental_history"]').value,
                "Diagnosis": document.querySelector('[name="diagnosis"]').value,
                "TreatmentPlan": JSON.stringify(treatments),
                "WorkDone": document.querySelector('[name="work_done"]').value,
                "Prescription": document.querySelector('[name="prescription"]').value,
                "NextAppointment": document.querySelector('[name="next_appointment"]').value,
                "NextAppointmentPurpose": document.querySelector('[name="next_appointment_purpose"]').value,
                "Remarks": document.querySelector('[name="remarks"]').value,
                "ConsentPatientName": document.querySelector('[name="consent_patient_name"]').value,
                "ConsentGuardianName": document.querySelector('[name="consent_guardian_name"]').value,
                "ConsentDate": document.querySelector('[name="consent_date"]').value,
                "Signature": document.getElementById('signature-data').value,
                "TotalFee": parseFloat(document.getElementById('totalFee').textContent.replace('₹', '')) || 0,
                "AmountPaid": parseFloat(document.querySelector('[name="amount_paid"]').value) || 0,
                "PaymentMode": document.querySelector('[name="payment_mode"]').value,
                "PaymentReference": document.querySelector('[name="payment_reference"]').value,
                "PaymentDate": document.querySelector('[name="payment_date"]').value,
                "BalanceAmount": parseFloat(document.querySelector('[name="balance_amount"]').value) || 0,
                "PaymentStatus": document.querySelector('[name="payment_status"]').value,
                "PaymentNotes": document.querySelector('[name="payment_notes"]').value
            };

            // Send data to Google Sheet
            const scriptURL = "https://script.google.com/macros/s/AKfycbyGU3tidafVAKHFBohVqdKmy3uBAtbi_gJP9T0iZWkCXtQANAK4mL3fyvIgpjvL8I8L/exec";
            
            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: JSON.stringify(formData),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();
                
                if (result.success) {
                    return result;
                } else {
                    throw new Error(result.message || 'Failed to save data');
                }
            } catch (error) {
                console.error('Error:', error);
                throw new Error('Failed to save data to Google Sheet: ' + error.message);
            }
        }
        
        // Save draft to localStorage
        document.getElementById('saveDraft').addEventListener('click', function() {
            const formData = new FormData(document.getElementById('patientForm'));
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
            // Save signature if exists
            if (!signaturePad.isEmpty()) {
                data.signature_data = signaturePad.toDataURL();
            }
            
            // Save treatment plan
            const treatments = [];
            document.querySelectorAll('#treatmentTable tbody tr').forEach(row => {
                treatments.push({
                    tooth: row.cells[0].textContent,
                    procedure: row.cells[1].textContent,
                    description: row.cells[2].textContent,
                    fee: row.cells[3].textContent.replace('₹', '')
                });
            });
            data.treatments = treatments;
            
            localStorage.setItem('patientFormDraft', JSON.stringify(data));
            
            Swal.fire({
                position: 'top-end',
                icon: 'success',
                title: 'Draft saved successfully!',
                showConfirmButton: false,
                timer: 1500,
                toast: true
            });
        });
        
        // Load draft from localStorage
        window.addEventListener('load', function() {
            const draft = localStorage.getItem('patientFormDraft');
            if (draft) {
                Swal.fire({
                    title: 'Load Saved Draft?',
                    text: "You have an unsaved draft. Would you like to load it?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: 'var(--primary)',
                    cancelButtonColor: 'var(--danger)',
                    confirmButtonText: 'Yes, load it!',
                    cancelButtonText: 'No, start fresh'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const data = JSON.parse(draft);
                        
                        // Populate form fields
                        for (const key in data) {
                            const element = document.querySelector(`[name="${key}"]`);
                            if (element) {
                                if (element.type === 'checkbox' || element.type === 'radio') {
                                    if (element.value === data[key]) {
                                        element.checked = true;
                                    }
                                } else {
                                    element.value = data[key];
                                }
                            }
                        }
                        
                        // Load signature if exists
                        if (data.signature_data) {
                            signaturePad.fromDataURL(data.signature_data);
                            document.getElementById('signature-data').value = data.signature_data;
                        }
                        
                        // Load treatments if exists
                        if (data.treatments && Array.isArray(data.treatments)) {
                            const tableBody = document.querySelector('#treatmentTable tbody');
                            const paymentSummary = document.getElementById('paymentSummary');
                            
                            data.treatments.forEach(treatment => {
                                // Add to treatment table
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${treatment.tooth}</td>
                                    <td>${treatment.procedure}</td>
                                    <td>${treatment.description || '-'}</td>
                                    <td>₹${treatment.fee}</td>
                                    <td><button type="button" class="btn btn-danger btn-sm remove-treatment"><i class="fas fa-trash"></i></button></td>
                                `;
                                tableBody.appendChild(row);
                                
                                // Add to payment summary
                                const paymentRow = document.createElement('tr');
                                paymentRow.innerHTML = `
                                    <td>${treatment.procedure}</td>
                                    <td>${treatment.tooth}</td>
                                    <td>₹${treatment.fee}</td>
                                `;
                                paymentSummary.appendChild(paymentRow);
                                
                                // Add event listener to remove button
                                row.querySelector('.remove-treatment').addEventListener('click', function() {
                                    row.remove();
                                    paymentRow.remove();
                                    updateTotalFee();
                                });
                            });
                            
                            // Update total fee
                            updateTotalFee();
                        }
                        
                        Swal.fire({
                            position: 'top-end',
                            icon: 'success',
                            title: 'Draft loaded!',
                            showConfirmButton: false,
                            timer: 1500,
                            toast: true
                        });
                    } else {
                        localStorage.removeItem('patientFormDraft');
                    }
                });
            }
        });
        
        // Initialize search functionality
        function initializeSearch() {
            const searchBtn = document.getElementById('searchBtn');
            
            searchBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('searchInput').value.trim();
                
                if (!searchTerm) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Search Error',
                        text: 'Please enter a patient name or mobile number to search',
                        confirmButtonColor: 'var(--primary)'
                    });
                    return;
                }
                
                // Here you would typically make an API call to search for patients
                // For demo purposes, we'll simulate a search result
               
                const scriptURL = "https://script.google.com/macros/s/AKfycby1RiOKwE_cirFCdeBOnJKqJlAJQnNowOjOWtd6xX7CBiOFP-pbHhOrbt81JhplXEM/exec";

                fetch(`${scriptURL}?query=${encodeURIComponent(searchTerm.toLowerCase())}`).then(response => response.json()).then(result => {
                    Swal.fire({
                        title: 'Search Results',
                        html: result.length > 0
                        ? result.map(row => `<p>${row.join(', ')}</p>`).join('')
                        : '<p>No results found.</p>',
                        confirmButtonColor: 'var(--primary)',
                    });
                })
                .catch(err => {
                console.error(err);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to fetch data from sheet.',
                    });
                });
                
            });
        }
    </script>
</body>
</html>